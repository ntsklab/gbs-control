<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="783px" preserveAspectRatio="none" style="width:2046px;height:783px;" version="1.1" viewBox="0 0 2046 783" width="2046px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="Noto Sans CJK JP" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="450" x="804" y="20.8799">Arduinoコンパチレイヤ変換フロー（gbs-control-esp）</text><!--MD5=[cbc0be2e139dd15b0007deace4fc5f27]
cluster  --><polygon fill="#FFFFFF" points="22,50.5638,31,50.5638,38,76.8357,2024,76.8357,2024,771.0638,22,771.0638,22,50.5638" style="stroke: #FFFFFF; stroke-width: 1.5;"/><line style="stroke: #FFFFFF; stroke-width: 1.5;" x1="22" x2="38" y1="76.8357" y2="76.8357"/><text fill="#FFFFFF" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="29" y="68.8038"/><!--MD5=[43a1252305bd850efe2e9563866807d4]
cluster Application Layer (移植対象)--><polygon fill="#FFFFFF" points="496,97.5638,690,97.5638,697,123.8357,1064,123.8357,1064,213.5638,496,213.5638,496,97.5638" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="496" x2="697" y1="123.8357" y2="123.8357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="188" x="500" y="115.8038">Application Layer (移植対象)</text><!--MD5=[7095573df0cc889ef310b79bb0eb450b]
cluster Arduino Compat API Surface\ncomponents/compat/include--><polygon fill="#FFFFFF" points="389,265.5638,595,265.5638,602,312.1077,1718,312.1077,1718,401.5638,389,401.5638,389,265.5638" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="389" x2="602" y1="312.1077" y2="312.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="194" x="396" y="283.8038">Arduino Compat API Surface</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="393" y="304.0757">components/compat/include</text><!--MD5=[d116a9df0cef335ede9f4be361edee85]
cluster Compat Implementation\ncomponents/compat--><polygon fill="#FFFFFF" points="412,435.0638,589,435.0638,596,481.6077,1134,481.6077,1134,571.0638,412,571.0638,412,435.0638" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="412" x2="596" y1="481.6077" y2="481.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="171" x="416" y="453.3038">Compat Implementation</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="429" y="473.5757">components/compat</text><!--MD5=[c25f37fb99adadcd97c843c7dc5d08f9]
cluster ESP-IDF APIs--><polygon fill="#FFFFFF" points="208,652.0638,302,652.0638,309,678.3357,1622,678.3357,1622,747.0638,208,747.0638,208,652.0638" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="208" x2="309" y1="678.3357" y2="678.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="212" y="670.3038">ESP-IDF APIs</text><path d="M197.5,482.0638 L197.5,567.3599 L392.5,567.3599 L392.5,492.0638 L382.5,482.0638 L197.5,482.0638 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M382.5,482.0638 L382.5,492.0638 L392.5,492.0638 L382.5,482.0638 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="203.5" y="502.1439">互換ポリシー:</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="203.5" y="520.9679">- 必要最小APIのみ実装</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="203.5" y="539.7919">- 一部APIはスタブ/No-op</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="203.5" y="558.6159">- 完全なArduino互換は目的外</text><path d="M110.5,322.0638 L110.5,388.5359 L369.5,388.5359 L369.5,332.0638 L359.5,322.0638 L110.5,322.0638 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M359.5,322.0638 L359.5,332.0638 L369.5,332.0638 L359.5,322.0638 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="116.5" y="342.1439">gbs_control.cpp では digitalRead を</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="116.5" y="360.9679">直接 gpio_get_level に再定義して高速化</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="116.5" y="379.7919">(#undef/#define digitalRead)</text><!--MD5=[4541fb81c80c07473fe4b07432ef0971]
entity app--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="683" y="136.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="678" y="141.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="678" y="187.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="693" y="162.8038">gbs_control.cpp</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="693" y="183.0757">(gbs_setup/gbs_loop)</text><!--MD5=[00179af9bc14e048fef3c02ab7970256]
entity pwm--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="163" x="884.5" y="147.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="879.5" y="152.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="879.5" y="177.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="894.5" y="173.3038">PersWiFiManager.cpp</text><!--MD5=[2b3ff478e007de30f424c5f8c5f53fb3]
entity i2c_clients--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="136" x="512" y="136.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="507" y="141.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="507" y="187.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="116" x="522" y="162.8038">SSD1306Wire.cpp</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="522" y="183.0757">si5351mcu.cpp</text><!--MD5=[cb7a91ad4de6b05e50f395da6df46354]
entity arduino_h--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="294" x="1092" y="324.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1087" y="329.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1087" y="375.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="1102" y="350.8038">Arduino.h</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="274" x="1102" y="371.0757">(digitalWrite/millis/delay/attachInterrupt)</text><!--MD5=[6c3a7b4ae083fa34dc5d0a50322987be]
entity wire_h--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="405" y="324.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="400" y="329.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="400" y="375.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="42" x="415" y="350.8038">Wire.h</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="66" x="415" y="371.0757">(TwoWire)</text><!--MD5=[52b7513755c1cf5bde2628ffc6fbf40f]
entity wifi_h--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="1584" y="324.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1579" y="329.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1579" y="375.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1594" y="350.8038">ESP8266WiFi.h</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="1594" y="371.0757">(WiFiClass)</text><!--MD5=[d57cb92530b348503863424327c3b971]
entity web_h--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="167" x="526.5" y="324.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="521.5" y="329.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="521.5" y="375.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="536.5" y="350.8038">ESPAsyncWebServer.h</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="536.5" y="371.0757">(AsyncWebServer API)</text><!--MD5=[e9e25b65e10208994919b4586b0f1e39]
entity fs_h--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="1421" y="324.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1416" y="329.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1416" y="375.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="29" x="1431" y="350.8038">FS.h</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1431" y="371.0757">(SPIFFS/File/Dir)</text><!--MD5=[2df424908b0954ecd0e773e967fdddc3]
entity net_h--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="328" x="729" y="335.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="724" y="340.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="724" y="365.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="308" x="739" y="361.3038">ESP8266mDNS.h / ArduinoOTA.h / DNSServer.h</text><!--MD5=[90f90b1b1f4b24980ba72e32d8374e7f]
entity compat_cpp--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="289" x="829.5" y="494.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="824.5" y="499.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="824.5" y="544.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="839.5" y="520.3038">compat.cpp</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="269" x="839.5" y="540.5757">GPIO/Serial/WiFi/mDNS/OTA/DNS/SPIFFS</text><!--MD5=[60a503a105ec775247c5a6a6dc227fca]
entity wire_cpp--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="148" x="428" y="494.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="423" y="499.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="423" y="544.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="58" x="438" y="520.3038">Wire.cpp</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="128" x="438" y="540.5757">I2C master wrapper</text><!--MD5=[ce29ffbb8485e0924bd14399130592eb]
entity web_cpp--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="183" x="611.5" y="494.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="606.5" y="499.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="606.5" y="544.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="621.5" y="520.3038">WebServerCompat.cpp</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="163" x="621.5" y="540.5757">esp_http_server adapter</text><!--MD5=[48617ad9f9b150c5114249034558e3d4]
entity idf_gpio--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1313" y="691.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1308" y="696.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1308" y="721.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1323" y="717.3038">driver/gpio</text><!--MD5=[1dcb523a0057b89aa344ede1149fe252]
entity idf_time--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="165" x="1440.5" y="691.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1435.5" y="696.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1435.5" y="721.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="145" x="1450.5" y="717.3038">esp_timer + FreeRTOS</text><!--MD5=[f1d5a02995e866ed24e7620d4a430d1a]
entity idf_uart--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="90" x="515" y="691.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="510" y="696.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="510" y="721.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="525" y="717.3038">driver/uart</text><!--MD5=[2b43c65d1c41a1c3d5049c0f8f66dc0d]
entity idf_wifi--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="236" x="640" y="691.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="635" y="696.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="635" y="721.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="216" x="650" y="717.3038">esp_wifi + esp_netif + esp_event</text><!--MD5=[90a2478121e268f1c0cee6ad9de579be]
entity idf_http--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="352" y="691.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="347" y="696.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="347" y="721.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="362" y="717.3038">esp_http_server</text><!--MD5=[aebbcda88defcf6feb6b2e639324f6ee]
entity idf_i2c--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="223.5" y="691.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="218.5" y="696.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="218.5" y="721.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="233.5" y="717.3038">i2c_master</text><!--MD5=[29e9966dfc9bee1ba64e4a6bc0cb331d]
entity idf_fs--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="185" x="911.5" y="691.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="906.5" y="696.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="906.5" y="721.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="165" x="921.5" y="717.3038">esp_vfs_spiffs + libc FILE</text><!--MD5=[bb723e66c68273cc2f88444392a918de]
entity idf_net--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="146" x="1132" y="691.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1127" y="696.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1127" y="721.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="126" x="1142" y="717.3038">mdns + lwip socket</text><!--MD5=[d1e8d03df838f77b118ac9aa4c118d12]
link app to arduino_h--><path d="M810.92,197.5838 C827.8,207.1038 847.61,216.4938 867,221.5638 C884.9,226.2438 1185.22,218.4338 1200,229.5638 C1227.42,250.2238 1236.04,290.0538 1238.51,319.1238 " fill="none" id="app-&gt;arduino_h" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1238.91,324.4138,1242.2303,315.1415,1238.5385,319.4277,1234.2524,315.7359,1238.91,324.4138" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="1217" y="245.6439">pinMode / digitalWrite / delay / millis</text><!--MD5=[d0a1e81acc5c8257b24584c092e1de64]
link app to wire_h--><path d="M721.03,197.7238 C704.42,207.1338 685.01,216.4238 666,221.5638 C654.52,224.6738 460.39,221.1338 452,229.5638 C429.17,252.5138 431.67,291.1938 437.68,319.3538 " fill="none" id="app-&gt;wire_h" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="438.84,324.4838,440.7655,314.825,437.7418,319.6059,432.9609,316.5822,438.84,324.4838" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="453" y="245.6439">Wire.begin(), tx/rx</text><!--MD5=[92177e1bf48f37c16d65c17de2f53fc6]
link app to wifi_h--><path d="M810.63,197.5738 C827.56,207.1638 847.48,216.5938 867,221.5638 C886.36,226.4838 1569.25,218.6838 1586,229.5638 C1616.53,249.4038 1630.93,290.0538 1637.57,319.5238 " fill="none" id="app-&gt;wifi_h" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1638.65,324.5238,1640.662,314.8827,1637.5955,319.6363,1632.8419,316.5698,1638.65,324.5238" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1608" y="245.6439">WiFi.mode(), WiFi.begin(), WiFi.status()</text><!--MD5=[98ed4b6e06e9f5541074843eb8fb1d17]
link app to web_h--><path d="M719.86,197.6938 C703.46,206.8638 684.48,216.0138 666,221.5638 C647.62,227.0938 592.93,215.3738 580,229.5638 C557.61,254.1338 571.6,292.4638 587.12,320.1038 " fill="none" id="app-&gt;web_h" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="589.62,324.4438,588.6069,314.6472,587.1301,320.1079,581.6694,318.6311,589.62,324.4438" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="581" y="245.6439">server.on(), request-&gt;send()</text><!--MD5=[31b57329bc8a0a89e8f0a6164f172e35]
link app to fs_h--><path d="M810.89,197.6938 C827.77,207.2238 847.58,216.5938 867,221.5638 C882.72,225.5838 1438.17,219.6338 1451,229.5638 C1477.85,250.3538 1484.82,290.1738 1486.05,319.1938 " fill="none" id="app-&gt;fs_h" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1486.21,324.4738,1489.9245,315.3523,1486.0525,319.4763,1481.9285,315.6043,1486.21,324.4738" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="1467" y="245.6439">SPIFFS.open(), Dir</text><!--MD5=[5af60c1453cf3e9de422ef4616d807a9]
link app to net_h--><path d="M758.44,197.7038 C755.89,213.7938 755.35,233.6038 763,249.5638 C780.77,286.6538 818.83,314.7438 849.2,332.4138 " fill="none" id="app-&gt;net_h" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="853.62,334.9538,847.7763,327.026,849.2744,332.4808,843.8195,333.9789,853.62,334.9538" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="764" y="245.6439">MDNS.update(), ArduinoOTA.handle(), dnsServer.processNextRequest()</text><!--MD5=[8f3d184ff6a400f546d531bd341a565b]
link pwm to wifi_h--><path d="M1047.51,170.4638 C1268.8,177.3838 1866.23,198.8238 1895,229.5638 C1956.18,294.9238 1800.24,330.5438 1706.96,345.4838 " fill="none" id="pwm-&gt;wifi_h" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1702.01,346.2638,1711.5264,348.8013,1706.948,345.4789,1710.2704,340.9005,1702.01,346.2638" style="stroke: #2D3748; stroke-width: 1.0;"/><!--MD5=[568213e8a1031c07cc800493e965f550]
link i2c_clients to wire_h--><path d="M511.73,178.5038 C455.71,188.6238 382.82,205.9238 365,229.5638 C359.65,236.6638 359.44,242.6338 365,249.5638 C375.26,262.3538 388.13,247.4138 401,257.5638 C420.5,272.9538 432.44,298.4838 439.4,319.4238 " fill="none" id="i2c_clients-&gt;wire_h" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="440.98,324.3638,442.035,314.5716,439.4504,319.6035,434.4185,317.019,440.98,324.3638" style="stroke: #2D3748; stroke-width: 1.0;"/><!--MD5=[b42888337b77e3e5ebf45e60f514605c]
link arduino_h to compat_cpp--><path d="M1192.23,385.6238 C1145.36,415.2538 1073.39,460.7438 1025.05,491.2938 " fill="none" id="arduino_h-&gt;compat_cpp" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1020.74,494.0138,1030.4852,492.5886,1024.9671,491.3433,1026.2124,485.8252,1020.74,494.0138" style="stroke: #2D3748; stroke-width: 1.0;"/><!--MD5=[9d1a7f125a468ef3c107da41c39db084]
link wire_h to wire_cpp--><path d="M457.53,385.6238 C466.87,414.5938 481.1,458.7338 490.94,489.2438 " fill="none" id="wire_h-&gt;wire_cpp" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="492.47,494.0138,493.5335,484.2226,490.9446,489.2522,485.9149,486.6633,492.47,494.0138" style="stroke: #2D3748; stroke-width: 1.0;"/><!--MD5=[692fb0348761ea5c7cb1dd4ad9302b2e]
link wifi_h to compat_cpp--><path d="M1607.37,385.8138 C1595.21,394.6538 1581.11,403.5738 1567,409.5638 C1423.52,470.5038 1246.67,499.1138 1123.61,512.3838 " fill="none" id="wifi_h-&gt;compat_cpp" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1118.52,512.9338,1127.8925,515.9599,1123.492,512.4052,1127.0467,508.0047,1118.52,512.9338" style="stroke: #2D3748; stroke-width: 1.0;"/><!--MD5=[9ee6409a3afb3902c66de4e5a78bd1a3]
link fs_h to compat_cpp--><path d="M1445.7,385.7138 C1432.9,394.3338 1418.3,403.1538 1404,409.5638 C1314.69,449.6038 1208.43,477.9338 1123.89,496.3438 " fill="none" id="fs_h-&gt;compat_cpp" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1118.86,497.4338,1128.5024,499.44,1123.7469,496.3764,1126.8105,491.621,1118.86,497.4338" style="stroke: #2D3748; stroke-width: 1.0;"/><!--MD5=[e54c5a4b31e20a01399c37b852bec78d]
link net_h to compat_cpp--><path d="M902.29,375.2738 C915.73,403.0738 940.81,454.9338 957.46,489.3638 " fill="none" id="net_h-&gt;compat_cpp" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="959.65,493.8938,959.3159,484.0506,957.4655,489.3963,952.1198,487.5459,959.65,493.8938" style="stroke: #2D3748; stroke-width: 1.0;"/><!--MD5=[491cd4e1afa5cfcce6e9a5a9b36c3628]
link web_h to web_cpp--><path d="M626.41,385.6238 C642.57,414.7138 667.21,459.0938 684.15,489.6238 " fill="none" id="web_h-&gt;web_cpp" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="686.6,494.0138,685.7258,484.2038,684.1718,489.6431,678.7326,488.089,686.6,494.0138" style="stroke: #2D3748; stroke-width: 1.0;"/><!--MD5=[da4710c81ca01846d2eff56eb07968ab]
link compat_cpp to idf_gpio--><path d="M1118.62,527.8438 C1239.7,533.1838 1399.09,549.3938 1440,597.0638 C1451.29,610.2138 1449.29,621.4238 1440,636.0638 C1435.53,643.1138 1429.79,639.2138 1423,644.0638 C1406.05,656.1738 1389.75,673.0838 1377.84,686.7638 " fill="none" id="compat_cpp-&gt;idf_gpio" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1374.29,690.8938,1383.1933,686.6829,1377.5522,687.1046,1377.1305,681.4635,1374.29,690.8938" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="1448" y="622.6439">gpio_config / gpio_set_level / gpio_get_level</text><!--MD5=[74142780b5b8481fee77366a5f448c6b]
link compat_cpp to idf_time--><path d="M1118.63,529.0038 C1326.13,535.4638 1687.88,552.9638 1728,597.0638 C1770.86,644.1838 1684.39,675.9638 1610.89,693.5238 " fill="none" id="compat_cpp-&gt;idf_time" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1605.62,694.7638,1615.2957,696.6025,1610.4878,693.6218,1613.4685,688.8139,1605.62,694.7638" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="1740" y="622.6439">esp_timer_get_time / vTaskDelay</text><!--MD5=[3b622bb83ee577fe51ce1969ae4d6c6c]
link compat_cpp to idf_uart--><path d="M897.59,555.1138 C870.89,564.2838 840.48,573.4438 812,579.0638 C784.35,584.5238 578.21,576.4438 559,597.0638 C537.06,620.6138 543.65,660.3938 551.22,685.9238 " fill="none" id="compat_cpp-&gt;idf_uart" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="552.74,690.8338,553.8835,681.0516,551.2535,686.0599,546.2452,683.43,552.74,690.8338" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="560" y="622.6439">uart_driver_install / uart_write_bytes</text><!--MD5=[8e825edfd0d7cce2d670237362bd3631]
link compat_cpp to idf_wifi--><path d="M895.19,555.2238 C872.55,566.1438 848.89,580.0838 830,597.0638 C801.78,622.4338 780.29,661.3538 768.41,686.2538 " fill="none" id="compat_cpp-&gt;idf_wifi" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="766.16,691.0338,773.6085,684.5903,768.2869,686.5088,766.3684,681.1872,766.16,691.0338" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="831" y="622.6439">esp_wifi_* / esp_netif_*</text><!--MD5=[7a37ff9af53d935d1e5c3db667885209]
link compat_cpp to idf_fs--><path d="M977.49,555.1938 C980.25,577.4838 984.39,608.7638 989,636.0638 C991.82,652.7538 995.61,671.4338 998.68,685.8538 " fill="none" id="compat_cpp-&gt;idf_fs" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="999.77,690.9638,1001.782,681.3227,998.7155,686.0763,993.9619,683.0098,999.77,690.9638" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="990" y="622.6439">esp_vfs_spiffs_register / fopen</text><!--MD5=[acd17b574c6f61976e409bcf514e144e]
link compat_cpp to idf_net--><path d="M1117.41,555.1038 C1140.14,565.2238 1161.53,578.8138 1178,597.0638 C1199.95,621.3938 1204.92,660.3438 1205.61,685.5638 " fill="none" id="compat_cpp-&gt;idf_net" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1205.7,690.7338,1209.5447,681.6664,1205.6141,685.7346,1201.5459,681.8039,1205.7,690.7338" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="1199" y="622.6439">mdns_* / UDP socket recvfrom/sendto</text><!--MD5=[91231d1a433bae2e435dfd9b7882f7e5]
link wire_cpp to idf_i2c--><path d="M467.74,555.0938 C454.86,564.4938 439.56,573.8038 424,579.0638 C386.69,591.6738 97.13,568.5138 70,597.0638 C19.76,649.9238 143.34,684.9238 218.05,700.6038 " fill="none" id="wire_cpp-&gt;idf_i2c" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="223.34,701.7038,215.3376,695.9626,218.4438,700.6903,213.716,703.7965,223.34,701.7038" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="115" y="613.1439">i2c_new_master_bus</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="71" y="631.9679">i2c_master_transmit/receive/probe</text><!--MD5=[f7354d49c69e71b1b07ac0ecde265afa]
link web_cpp to idf_http--><path d="M653.04,555.1538 C635.03,564.4338 614.16,573.6638 594,579.0638 C565.39,586.7338 348.23,575.4238 328,597.0638 C316.16,609.7238 320.68,620.3538 328,636.0638 C331.25,643.0338 362.47,668.4238 386.81,687.5338 " fill="none" id="web_cpp-&gt;idf_http" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="390.96,690.7838,386.353,682.0789,387.0279,687.6954,381.4115,688.3703,390.96,690.7838" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="69" x="377" y="613.1439">httpd_start</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="329" y="631.9679">httpd_register_uri_handler</text><!--MD5=[cc67b37fd83abbae010c2223af215234]
link compat_cpp to GMN51--><path d="M937.74,494.0238 C903.41,467.4438 849.13,431.2138 794.5,418.3138 C755.03,408.9938 468.97,408.9938 429.5,418.3138 C390.4,427.5438 355.14,456.5838 330.53,481.9738 " fill="none" id="compat_cpp-GMN51" style="stroke: #2D3748; stroke-width: 1.0; stroke-dasharray: 7.0,7.0;"/><!--MD5=[a8cb331f0bffa6d2287c748549e6d77c]
link app to GMN54--><path d="M721.04,197.7538 C704.43,207.1738 685.01,216.4538 666,221.5638 C615.54,235.1338 480.83,213.8338 431,229.5638 C371.17,248.4538 312.21,291.6738 275.98,321.8638 " fill="none" id="app-GMN54" style="stroke: #2D3748; stroke-width: 1.0; stroke-dasharray: 7.0,7.0;"/><!--MD5=[228cbe838f0102a36cb07072faf0d57e]
@startuml
skinparam backgroundColor white
skinparam shadowing false
skinparam defaultFontName Noto Sans CJK JP
skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam ArrowColor #2d3748
hide stereotype
skinparam package<<canvas>> {
  BackgroundColor #FFFFFF
  BorderColor #FFFFFF
  FontColor #FFFFFF
}

title Arduinoコンパチレイヤ変換フロー（gbs-control-esp）

package " " <<canvas>> {

package "Application Layer (移植対象)" {
  component "gbs_control.cpp\n(gbs_setup/gbs_loop)" as app
  component "PersWiFiManager.cpp" as pwm
  component "SSD1306Wire.cpp\nsi5351mcu.cpp" as i2c_clients
}

package "Arduino Compat API Surface\ncomponents/compat/include" {
  component "Arduino.h\n(digitalWrite/millis/delay/attachInterrupt)" as arduino_h
  component "Wire.h\n(TwoWire)" as wire_h
  component "ESP8266WiFi.h\n(WiFiClass)" as wifi_h
  component "ESPAsyncWebServer.h\n(AsyncWebServer API)" as web_h
  component "FS.h\n(SPIFFS/File/Dir)" as fs_h
  component "ESP8266mDNS.h / ArduinoOTA.h / DNSServer.h" as net_h
}

package "Compat Implementation\ncomponents/compat" {
  component "compat.cpp\nGPIO/Serial/WiFi/mDNS/OTA/DNS/SPIFFS" as compat_cpp
  component "Wire.cpp\nI2C master wrapper" as wire_cpp
  component "WebServerCompat.cpp\nesp_http_server adapter" as web_cpp
}

package "ESP-IDF APIs" {
  component "driver/gpio" as idf_gpio
  component "esp_timer + FreeRTOS" as idf_time
  component "driver/uart" as idf_uart
  component "esp_wifi + esp_netif + esp_event" as idf_wifi
  component "esp_http_server" as idf_http
  component "i2c_master" as idf_i2c
  component "esp_vfs_spiffs + libc FILE" as idf_fs
  component "mdns + lwip socket" as idf_net
}

app - -> arduino_h : pinMode / digitalWrite / delay / millis
app - -> wire_h : Wire.begin(), tx/rx
app - -> wifi_h : WiFi.mode(), WiFi.begin(), WiFi.status()
app - -> web_h : server.on(), request->send()
app - -> fs_h : SPIFFS.open(), Dir
app - -> net_h : MDNS.update(), ArduinoOTA.handle(), dnsServer.processNextRequest()

pwm - -> wifi_h
i2c_clients - -> wire_h

arduino_h - -> compat_cpp
wire_h - -> wire_cpp
wifi_h - -> compat_cpp
fs_h - -> compat_cpp
net_h - -> compat_cpp
web_h - -> web_cpp

compat_cpp - -> idf_gpio : gpio_config / gpio_set_level / gpio_get_level
compat_cpp - -> idf_time : esp_timer_get_time / vTaskDelay
compat_cpp - -> idf_uart : uart_driver_install / uart_write_bytes
compat_cpp - -> idf_wifi : esp_wifi_* / esp_netif_*
compat_cpp - -> idf_fs : esp_vfs_spiffs_register / fopen
compat_cpp - -> idf_net : mdns_* / UDP socket recvfrom/sendto

wire_cpp - -> idf_i2c : i2c_new_master_bus\ni2c_master_transmit/receive/probe
web_cpp - -> idf_http : httpd_start\nhttpd_register_uri_handler

note right of compat_cpp
  互換ポリシー:
  - 必要最小APIのみ実装
  - 一部APIはスタブ/No-op
  - 完全なArduino互換は目的外
end note

note bottom of app
  gbs_control.cpp では digitalRead を
  直接 gpio_get_level に再定義して高速化
  (#undef/#define digitalRead)
end note

}

@enduml

PlantUML version 1.2020.02(Sun Mar 01 19:22:07 JST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 21.0.10+7-Debian-1deb13u1
Operating System: Linux
Default Encoding: UTF-8
Language: ja
Country: JP
--></g></svg>