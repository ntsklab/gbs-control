<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1129px" preserveAspectRatio="none" style="width:2193px;height:1129px;" version="1.1" viewBox="0 0 2193 1129" width="2193px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="Noto Sans CJK JP" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="299" x="953" y="20.8799">gbs-control-esp 全体フロー（UML）</text><!--MD5=[cbc0be2e139dd15b0007deace4fc5f27]
cluster  --><polygon fill="#FFFFFF" points="22,50.0638,31,50.0638,38,76.3357,2171,76.3357,2171,1117.0638,22,1117.0638,22,50.0638" style="stroke: #FFFFFF; stroke-width: 1.5;"/><line style="stroke: #FFFFFF; stroke-width: 1.5;" x1="22" x2="38" y1="76.3357" y2="76.3357"/><text fill="#FFFFFF" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="0" x="29" y="68.3038"/><!--MD5=[a4f7159b2453b397dcb9d5c4aba3b909]
cluster ESP-IDF Runtime--><polygon fill="#FFFFFF" points="1026,97.0638,1150,97.0638,1157,123.3357,1184,123.3357,1184,375.0638,1026,375.0638,1026,97.0638" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="1026" x2="1157" y1="123.3357" y2="123.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1030" y="115.3038">ESP-IDF Runtime</text><!--MD5=[5fe1fd1079eca77adc238734e46a2ded]
cluster gbs_control component--><polygon fill="#FFFFFF" points="649,446.0638,820,446.0638,827,472.3357,1503,472.3357,1503,925.0638,649,925.0638,649,446.0638" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="649" x2="827" y1="472.3357" y2="472.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="653" y="464.3038">gbs_control component</text><!--MD5=[53c58219f3dc5fdc2978b1bf2203c8e8]
cluster shell + ble_serial--><polygon fill="#FFFFFF" points="1624,435.5638,1742,435.5638,1749,461.8357,1919,461.8357,1919,743.5638,1624,743.5638,1624,435.5638" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="1624" x2="1749" y1="461.8357" y2="461.8357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="1628" y="453.8038">shell + ble_serial</text><!--MD5=[5512aa1a5911a4305167816cfa7e2b1a]
cluster Peripherals / Storage--><polygon fill="#FFFFFF" points="46,977.0638,195,977.0638,202,1003.3357,780,1003.3357,780,1093.0638,46,1093.0638,46,977.0638" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="46" x2="202" y1="1003.3357" y2="1003.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="50" y="995.3038">Peripherals / Storage</text><!--MD5=[8fc3522a43f8c7199df5e09e5bb0188e]
entity user--><ellipse cx="1611" cy="135.0638" fill="#FEFECE" rx="8" ry="8" style="stroke: #A80036; stroke-width: 1.5;"/><path d="M1611,143.0638 L1611,170.0638 M1598,151.0638 L1624,151.0638 M1611,170.0638 L1598,185.0638 M1611,170.0638 L1624,185.0638 " fill="none" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="1596" y="203.8038">User</text><!--MD5=[23555a4f9c8a267cdfd801ad53ceaf15]
entity browser--><ellipse cx="1562" cy="473.5638" fill="#FEFECE" rx="8" ry="8" style="stroke: #A80036; stroke-width: 1.5;"/><path d="M1562,481.5638 L1562,508.5638 M1549,489.5638 L1575,489.5638 M1562,508.5638 L1549,523.5638 M1562,508.5638 L1575,523.5638 " fill="none" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="1519.5" y="542.3038">Web Browser</text><!--MD5=[62548c4d3a18da1b5712df35db6e7fa9]
entity bleclient--><ellipse cx="1805" cy="297.0638" fill="#FEFECE" rx="8" ry="8" style="stroke: #A80036; stroke-width: 1.5;"/><path d="M1805,305.0638 L1805,332.0638 M1792,313.0638 L1818,313.0638 M1805,332.0638 L1792,347.0638 M1805,332.0638 L1818,347.0638 " fill="none" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="1771.5" y="365.8038">BLE Client</text><path d="M1935.5,645.0638 L1935.5,749.1839 L2154.5,749.1839 L2154.5,655.0638 L2144.5,645.0638 L1935.5,645.0638 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2144.5,645.0638 L2144.5,655.0638 L2154.5,655.0638 L2144.5,645.0638 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1941.5" y="665.1439">実行ループでの主要順序:</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="1941.5" y="683.9679">1) OLED/UI更新</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="1941.5" y="702.7919">2) handleWiFi()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="1941.5" y="721.6159">3) コマンド受付/実行</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="1941.5" y="740.4399">4) sync watcher + レジスタ最適化</text><!--MD5=[bb6e7df1181211101974e0c98ca18f10]
entity app_main--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="122" x="1044" y="136.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1039" y="141.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1039" y="186.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="102" x="1054" y="162.3038">main/main.cpp</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="1054" y="182.5757">app_main()</text><!--MD5=[f63e3aa9e56232f4cd858b55a0096e29]
entity gbs_task--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="125" x="1042.5" y="298.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1037.5" y="303.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1037.5" y="348.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="1052.5" y="324.3038">gbs_task()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="1052.5" y="344.5757">(FreeRTOS task)</text><!--MD5=[179fc153c76999af38ad3df6aab624a4]
entity gbs_setup--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="100" x="665" y="485.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="660" y="490.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="660" y="515.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="675" y="511.3038">gbs_setup()</text><!--MD5=[d1f4e74f5ca1717ca1ea858728cf5081]
entity gbs_loop--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="91" x="1059.5" y="677.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1054.5" y="682.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1054.5" y="707.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="1069.5" y="703.3038">gbs_loop()</text><!--MD5=[08af8945a84acfe1eabc0963aa87c412]
entity web--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="665.5" y="666.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="660.5" y="671.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="660.5" y="717.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="109" x="675.5" y="692.8038">startWebserver()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="675.5" y="713.0757">HTTP / WebSocket</text><!--MD5=[40e3a1898867be20c4aacfe340ab9403]
entity wifi--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="182" x="783" y="848.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="778" y="853.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="778" y="898.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="85" x="793" y="874.3038">handleWiFi()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="162" x="793" y="894.5757">MDNS/DNS/OTA/WS ping</text><!--MD5=[8b44882b8e17850e01b1ad5c18eac763]
entity sync--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="213" x="1000.5" y="848.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="995.5" y="853.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="995.5" y="898.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="1010.5" y="874.3038">runSyncWatcher()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="193" x="1010.5" y="894.5757">mode detect + applyPresets()</text><!--MD5=[f04bcface800b3498ac77214835b90cd]
entity cmd--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="238" x="1249" y="848.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1244" y="853.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1244" y="898.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="181" x="1259" y="874.3038">Serial command dispatcher</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="218" x="1259" y="894.5757">(serialCommand/userCommand)</text><!--MD5=[90bd7bfaf115c178cab719a530508b90]
entity shell--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="1640" y="485.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1635" y="490.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1635" y="515.3357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="1650" y="511.3038">shell_init()</text><!--MD5=[356b21d33ae4bbe89a0e9541f25b232f]
entity ble--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="135" x="1767.5" y="474.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1762.5" y="479.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1762.5" y="525.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="105" x="1777.5" y="500.8038">ble_serial_init()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="115" x="1777.5" y="521.0757">NUS GATT service</text><!--MD5=[571539a19b26ae2a4a45371a0cee1373]
entity shelltask--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="164" x="1691" y="666.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1686" y="671.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="1686" y="717.1077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="1701" y="692.8038">shell_ble_cmd_task()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="136" x="1701" y="713.0757">process_command()</text><!--MD5=[de382f5d3145b057fc4301680716463e]
entity gbschip--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="128" x="636" y="1016.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="631" y="1021.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="631" y="1066.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="646" y="1042.3038">GBS8200 (I2C)</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="646" y="1062.5757">TV5725 registers</text><!--MD5=[a69d669ad8f1a4b6f2e8a2047d54bfc3]
entity oled--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="169" x="61.5" y="1026.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="56.5" y="1031.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="56.5" y="1056.8357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="149" x="71.5" y="1052.8038">OLED + Rotary Encoder</text><!--MD5=[ad4229f7d83ce039522f500d4650787f]
entity spiffs--><rect fill="#FEFECE" height="60.5438" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="265.5" y="1016.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="260.5" y="1021.0638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="260.5" y="1066.6077"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="45" x="275.5" y="1042.3038">SPIFFS</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="121" x="275.5" y="1062.5757">preferences / slots</text><!--MD5=[162363f673e316b906fa47750e3cf30b]
entity wlan--><rect fill="#FEFECE" height="40.2719" style="stroke: #A80036; stroke-width: 1.5;" width="159" x="441.5" y="1026.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="436.5" y="1031.5638"/><rect fill="#FEFECE" height="5" style="stroke: #A80036; stroke-width: 1.5;" width="10" x="436.5" y="1056.8357"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="139" x="451.5" y="1052.8038">Wi-Fi STA/AP + mDNS</text><!--MD5=[42320de4a0acaa05f7111737c8640c0a]
link user to browser--><path d="M1605.14,207.8238 C1595.94,270.9838 1578.18,392.9538 1568.57,458.9838 " fill="none" id="user-&gt;browser" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1567.83,464.0238,1573.0761,455.6885,1568.5451,459.0752,1565.1583,454.5443,1567.83,464.0238" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="1593" y="334.6439">HTTPアクセス</text><!--MD5=[a866ad135f1f56fc376fb1d3db47cbf4]
link user to bleclient--><path d="M1626.22,180.1138 C1656.34,204.9538 1724.3,261.0138 1767.22,296.4038 " fill="none" id="user-&gt;bleclient" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1771.29,299.7638,1766.898,290.9485,1767.4349,296.5798,1761.8036,297.1167,1771.29,299.7638" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="1720" y="253.6439">BLEシェル接続</text><!--MD5=[910a9c4fd331cbf66b5ed7b7bf970afd]
link app_main to shell--><path d="M1148.7,197.3438 C1164.41,209.0038 1181.75,223.0638 1196,237.5638 C1252.46,294.9938 1244.1,329.2238 1304,383.0638 C1327.78,404.4438 1335.28,410.7038 1366,419.5638 C1394.84,427.8838 1609.82,412.8938 1636,427.5638 C1656.12,438.8338 1669.51,461.9638 1677.33,479.8538 " fill="none" id="app_main-&gt;shell" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1679.38,484.7538,1679.574,474.9069,1677.4397,480.1457,1672.2009,478.0113,1679.38,484.7538" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="1305" y="334.6439">shell_init()</text><!--MD5=[4552bf73a278303852769c6c72819342]
link app_main to gbs_task--><path d="M1105,197.2838 C1105,224.3338 1105,264.2938 1105,292.8138 " fill="none" id="app_main-&gt;gbs_task" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1105,298.0038,1109,289.0038,1105,293.0038,1101,289.0038,1105,298.0038" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="1106" y="253.6439">xTaskCreate()</text><!--MD5=[b1d8c7c0ae2f0e74afd89ac55a1f92ac]
link gbs_task to gbs_setup--><path d="M1042.34,357.6038 C964.33,392.5038 832.81,451.3538 762.58,482.7738 " fill="none" id="gbs_task-&gt;gbs_setup" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="757.63,484.9938,767.4788,484.9624,762.1925,482.9486,764.2064,477.6623,757.63,484.9938" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="945" y="415.6439">1回だけ実行</text><!--MD5=[93898f062db32f01ed6d94c1a0886cf7]
link gbs_setup to web--><path d="M717.03,525.3238 C720.38,557.2038 727.13,621.3438 731.34,661.2938 " fill="none" id="gbs_setup-&gt;web" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="731.89,666.5238,734.916,657.1514,731.3614,661.5519,726.9609,657.9972,731.89,666.5238" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="727" y="601.6439">startWebserver()</text><!--MD5=[3b367aa0baafd334da15525a10d1aecc]
link gbs_setup to spiffs--><path d="M664.84,515.8638 C559.55,539.4838 317.44,610.5538 223,779.0638 C182.88,850.6438 205.59,894.8138 254,961.0638 C267.23,979.1738 284.18,997.2738 299.23,1012.0538 " fill="none" id="gbs_setup-&gt;spiffs" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="303.01,1015.7438,299.3448,1006.6024,299.4248,1012.2586,293.7685,1012.3386,303.01,1015.7438" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="224" y="795.1439">SPIFFS.begin()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="226.5" y="813.9679">設定読込/保存</text><!--MD5=[d846b57082dc95aaa6873b11e76546be]
link gbs_setup to gbschip--><path d="M684.01,525.1038 C614.07,570.3938 446.92,692.5138 406,848.0638 C396.39,884.5938 381.63,904.2038 406,933.0638 C467.66,1006.0838 532.34,926.6838 618,969.0638 C638.75,979.3338 657.92,996.5638 672.5,1012.0838 " fill="none" id="gbs_setup-&gt;gbschip" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="676.1,1015.9838,672.9196,1006.6626,672.7027,1012.3153,667.05,1012.0983,676.1,1015.9838" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="432" y="804.6439">startWire() + 初期レジスタ設定</text><!--MD5=[bfdca8f153686d51290b0884c8f6b17e]
link gbs_setup to oled--><path d="M665,507.4338 C533.91,514.1638 183.46,553.3838 82,779.0638 C43.91,863.7838 101.12,974.2538 130.44,1021.9438 " fill="none" id="gbs_setup-&gt;oled" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="133.19,1026.3638,131.8268,1016.6098,130.5464,1022.1198,125.0364,1020.8395,133.19,1026.3638" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="102" y="795.1439">display.init()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="83" y="813.9679">encoder ISR attach</text><!--MD5=[c142ffc5a19c9d4599bc57f23f877cc4]
link gbs_task to gbs_loop--><path d="M1081.61,359.4038 C1068.64,377.8938 1053.79,402.7738 1047,427.5638 C1022.53,516.9538 1068.63,625.3438 1092.26,672.3838 " fill="none" id="gbs_task-&gt;gbs_loop" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1094.61,677.0138,1094.1125,667.1776,1092.3511,672.5532,1086.9754,670.7918,1094.61,677.0138" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="1048" y="511.1439">while(true)</text><!--MD5=[6c5e4abe3adcf5726837e07dd96ac62a]
link gbs_loop to wifi--><path d="M1059.37,706.7338 C953.5,726.9038 699.9,775.5338 697,779.0638 C686,792.4638 686.88,803.9938 697,818.0638 C702.47,825.6738 739.07,838.5338 777.58,850.3538 " fill="none" id="gbs_loop-&gt;wifi" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="782.77,851.9438,775.3307,845.4896,777.988,850.4835,772.9941,853.1408,782.77,851.9438" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="698" y="804.6439">handleWiFi(0)</text><!--MD5=[febe2fc4448d7ff57da2d182088fee31]
link gbs_loop to sync--><path d="M1103.73,717.1938 C1102.35,740.8738 1100.51,782.4638 1102,818.0638 C1102.34,826.1238 1102.93,834.7838 1103.6,842.9338 " fill="none" id="gbs_loop-&gt;sync" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1104.02,847.9338,1107.2345,838.6243,1103.5918,842.9522,1099.2639,839.3095,1104.02,847.9338" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="1103" y="804.6439">runSyncWatcher()</text><!--MD5=[eb1235d980bb96cf59b6faf36f4e2182]
link gbs_loop to cmd--><path d="M1134.75,717.1938 C1158.05,732.7338 1190.79,755.8138 1217,779.0638 C1234.64,794.7238 1234.24,803.7638 1253,818.0638 C1266.28,828.1938 1281.55,837.4538 1296.52,845.5038 " fill="none" id="gbs_loop-&gt;cmd" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1301.15,847.9538,1295.0652,840.2095,1296.7304,845.6157,1291.3242,847.2809,1301.15,847.9538" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1254" y="804.6439">serialCommand/userCommandを処理</text><!--MD5=[8139a071df623c2eb86a8d864bf4df55]
link gbs_loop to gbschip--><path d="M1059.48,706.6638 C950.43,727.2638 683.07,777.8738 681,779.0638 C645.77,799.3238 635.24,810.0038 621,848.0638 C607.77,883.4438 615.76,895.6538 621,933.0638 C622.8,945.8838 622.93,949.6338 629,961.0638 C638.7,979.3138 652.83,997.1838 665.93,1011.7538 " fill="none" id="gbs_loop-&gt;gbschip" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="669.6,1015.7738,666.4769,1006.4333,666.2253,1012.0845,660.574,1011.8328,669.6,1015.7738" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="622" y="884.6439">画像処理パラメータ更新</text><!--MD5=[03935ef2adc817331da3cc0923730f46]
link browser to web--><path d="M1519.31,537.8538 C1513.99,540.9538 1508.48,543.7838 1503,546.0638 C1439.08,572.6638 990.03,652.0038 809.69,683.2338 " fill="none" id="browser-&gt;web" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="804.7,684.0938,814.2455,686.5195,809.6285,683.251,812.8969,678.634,804.7,684.0938" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="1376" y="601.6439">/sc, /uc, /slot/*, /wifi/*</text><!--MD5=[5da2597235ccfed32f3763cc88af3dbc]
link web to cmd--><path d="M754.46,727.6938 C775.13,756.3638 810.63,798.3038 853,818.0638 C929.36,853.6838 1147.63,835.8338 1231,848.0638 C1235.24,848.6838 1239.54,849.3638 1243.88,850.0838 " fill="none" id="web-&gt;cmd" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1248.99,850.9438,1240.7777,845.5071,1244.0592,850.1149,1239.4514,853.3964,1248.99,850.9438" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="854" y="804.6439">serialCommand / userCommand を設定</text><!--MD5=[bc41b0413d375acb868f48e7d92a71a8]
link web to spiffs--><path d="M665.09,703.2238 C562.5,712.2338 378.24,734.2738 331,779.0638 C318.02,791.3738 332.33,804.2138 321,818.0638 C301.62,841.7638 275.26,822.1338 259,848.0638 C238.93,880.0738 247.83,896.9738 259,933.0638 C268.05,962.3138 287.62,990.7338 304.76,1011.6938 " fill="none" id="web-&gt;spiffs" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="308.16,1015.7838,305.4747,1006.3081,304.9605,1011.9416,299.327,1011.4274,308.16,1015.7838" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="260" y="884.6439">プリセットslot保存/読込</text><!--MD5=[37aeff31684b6e527e11237cfddd2711]
link web to wlan--><path d="M677.44,727.6538 C651.22,742.0038 620.25,760.1938 594,779.0638 C572.78,794.3138 573.14,805.9238 550,818.0638 C500.55,844.0038 462.45,804.1138 428,848.0638 C384.17,903.9738 454.39,983.9038 495.14,1022.6938 " fill="none" id="web-&gt;wlan" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="498.99,1026.3138,495.1777,1017.2328,495.349,1022.887,489.6947,1023.0584,498.99,1026.3138" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="429" y="884.6439">接続制御, AP/STA切替</text><!--MD5=[4b2102890bfada3f82a7923ca87be47a]
link bleclient to ble--><path d="M1811.88,369.5938 C1817.06,399.7238 1824.09,440.5838 1829.03,469.3338 " fill="none" id="bleclient-&gt;ble" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1829.93,474.5638,1832.3557,465.0184,1829.0872,469.6354,1824.4701,466.3669,1829.93,474.5638" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="1821" y="415.6439">NUS RX write</text><!--MD5=[76aad970ad2bc30d44d7a202487dbd82]
link ble to shelltask--><path d="M1825.31,535.7538 C1814.24,569.6738 1796.15,625.1238 1784.41,661.1138 " fill="none" id="ble-&gt;shelltask" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1782.72,666.2738,1789.3213,658.9647,1784.2754,661.5219,1781.7182,656.4761,1782.72,666.2738" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="1812" y="592.1439">shell_ble_line_cb()</text><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="1837.5" y="610.9679">queue投入</text><!--MD5=[4bac04c64d0fee693aed2baf43c908b9]
link shelltask to cmd--><path d="M1690.76,713.6638 C1639.88,725.9338 1574.81,746.5038 1524,779.0638 C1504.14,791.7938 1506.88,803.9238 1488,818.0638 C1474.34,828.2938 1458.64,837.5538 1443.21,845.5538 " fill="none" id="shelltask-&gt;cmd" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="1438.43,847.9938,1448.2629,847.4334,1442.8761,845.7065,1444.6031,840.3197,1438.43,847.9938" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="1525" y="804.6439">serialCommand / userCommand を設定</text><!--MD5=[b67ed93310c68b46cac972f757c12b12]
link shelltask to gbschip--><path d="M1779.95,727.6838 C1784.3,753.7838 1786.11,791.6738 1768,818.0638 C1695.35,923.9238 1626.59,898.2838 1503,933.0638 C1238.44,1007.5138 910.36,1033.8438 769.52,1042.1438 " fill="none" id="shelltask-&gt;gbschip" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="764.18,1042.4538,773.4034,1045.9076,769.171,1042.1544,772.9243,1037.922,764.18,1042.4538" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1744" y="884.6439">debug reg read/write</text><!--MD5=[694e8e752115001b990977d89456e89b]
link wifi to wlan--><path d="M813.87,909.1938 C795.55,917.5638 775.18,926.2538 756,933.0638 C696.68,954.1338 675.42,941.1238 619,969.0638 C590.95,982.9538 563.23,1005.6638 544.47,1022.7338 " fill="none" id="wifi-&gt;wlan" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="540.37,1026.5038,549.6979,1023.3431,544.0457,1023.1142,544.2745,1017.462,540.37,1026.5038" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="728" y="957.1439">MDNS.update(), DNS処理</text><!--MD5=[ba63a6e49a7e376fbd1f8e539012f299]
link sync to gbschip--><path d="M1039.58,909.0738 C1021.27,916.9738 1001.41,925.4338 983,933.0638 C910.31,963.1838 826.5,996.3038 769.06,1018.7538 " fill="none" id="sync-&gt;gbschip" style="stroke: #2D3748; stroke-width: 1.0;"/><polygon fill="#2D3748" points="764.28,1020.6238,774.1181,1021.084,768.9389,1018.8088,771.2141,1013.6297,764.28,1020.6238" style="stroke: #2D3748; stroke-width: 1.0;"/><text fill="#000000" font-family="Noto Sans CJK JP" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="961" y="957.1439">モード判定, applyPresets()</text><!--MD5=[d6e172db87f530acfd4b4ea6e35015be]
link gbs_loop to GMN50--><path d="M1150.7,677.9038 C1274.61,628.7538 1626.17,508.0338 1901.5,595.5638 C1933.05,605.5938 1963.64,625.3538 1988.41,644.7938 " fill="none" id="gbs_loop-GMN50" style="stroke: #2D3748; stroke-width: 1.0; stroke-dasharray: 7.0,7.0;"/><!--MD5=[dfe054c6260ca5696d41a69f46bb65b0]
@startuml
skinparam backgroundColor white
skinparam shadowing false
skinparam defaultFontName Noto Sans CJK JP
skinparam componentStyle rectangle
skinparam ArrowColor #2d3748
skinparam packageStyle rectangle
hide stereotype
skinparam package<<canvas>> {
  BackgroundColor #FFFFFF
  BorderColor #FFFFFF
  FontColor #FFFFFF
}

title gbs-control-esp 全体フロー（UML）

package " " <<canvas>> {
actor "User" as user
actor "Web Browser" as browser
actor "BLE Client" as bleclient

package "ESP-IDF Runtime" {
  component "main/main.cpp\napp_main()" as app_main
  component "gbs_task()\n(FreeRTOS task)" as gbs_task
}

package "gbs_control component" {
  component "gbs_setup()" as gbs_setup
  component "gbs_loop()" as gbs_loop
  component "startWebserver()\nHTTP / WebSocket" as web
  component "handleWiFi()\nMDNS/DNS/OTA/WS ping" as wifi
  component "runSyncWatcher()\nmode detect + applyPresets()" as sync
  component "Serial command dispatcher\n(serialCommand/userCommand)" as cmd
}

package "shell + ble_serial" {
  component "shell_init()" as shell
  component "ble_serial_init()\nNUS GATT service" as ble
  component "shell_ble_cmd_task()\nprocess_command()" as shelltask
}

package "Peripherals / Storage" {
  component "GBS8200 (I2C)\nTV5725 registers" as gbschip
  component "OLED + Rotary Encoder" as oled
  component "SPIFFS\npreferences / slots" as spiffs
  component "Wi-Fi STA/AP + mDNS" as wlan
}

user - -> browser : HTTPアクセス
user - -> bleclient : BLEシェル接続

app_main - -> shell : shell_init()
app_main - -> gbs_task : xTaskCreate()

gbs_task - -> gbs_setup : 1回だけ実行

gbs_setup - -> web : startWebserver()
gbs_setup - -> spiffs : SPIFFS.begin()\n設定読込/保存
gbs_setup - -> gbschip : startWire() + 初期レジスタ設定
gbs_setup - -> oled : display.init()\nencoder ISR attach

gbs_task - -> gbs_loop : while(true)
gbs_loop - -> wifi : handleWiFi(0)
gbs_loop - -> sync : runSyncWatcher()
gbs_loop - -> cmd : serialCommand/userCommandを処理
gbs_loop - -> gbschip : 画像処理パラメータ更新

browser - -> web : /sc, /uc, /slot/*, /wifi/*
web - -> cmd : serialCommand / userCommand を設定
web - -> spiffs : プリセットslot保存/読込
web - -> wlan : 接続制御, AP/STA切替

bleclient - -> ble : NUS RX write
ble - -> shelltask : shell_ble_line_cb()\nqueue投入
shelltask - -> cmd : serialCommand / userCommand を設定
shelltask - -> gbschip : debug reg read/write

wifi - -> wlan : MDNS.update(), DNS処理
sync - -> gbschip : モード判定, applyPresets()

note right of gbs_loop
  実行ループでの主要順序:
  1) OLED/UI更新
  2) handleWiFi()
  3) コマンド受付/実行
  4) sync watcher + レジスタ最適化
end note
}

@enduml

PlantUML version 1.2020.02(Sun Mar 01 19:22:07 JST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 21.0.10+7-Debian-1deb13u1
Operating System: Linux
Default Encoding: UTF-8
Language: ja
Country: JP
--></g></svg>